import os
import glob
import pickle


# we need to pass in our our dataset, textgenerator to get text, embedding to get embedding, and then run each model on the embedding
def generate_params(embedding, popularity=None, verbose=False):
    """
    Takes vector space of dimension 384 and outputs a prediction for each of 12 audio parameters
    using 12 separate pre-trained XGBoostRegressor models.
    Returns a dictionary of predicted parameters, including desired genre and playlist length.
    """
    parameters = ['acousticness', 'danceability', 'energy', 'instrumentalness',
                  'key', 'liveness', 'target_loudness', 'mode', 'speechiness',
                  'tempo', 'signature', 'valence']

    # Create dictionary to be added to (with popularity if argument has been passed)
    if popularity:
        spotify_features = {'target_popularity': popularity}
    else:
        spotify_features = {}

    # Find the XGB files
    xgboost_files = os.path.join("../model_xgb_384/*_model_xgb_384")
    xgboost_models = glob.glob(xgboost_files)

    # Use each XGB model to predict on corresponding audio parameter
    for parameter, model in zip(parameters, xgboost_models):
        with open(model, 'rb') as f:
            xgb_model = pickle.load(f)
        preds = xgb_model.predict(embedding.reshape(1, -1))
        spotify_features[parameter] = preds[0]

    if verbose:
        print(spotify_features)
    return spotify_features


if __name__ == '__main__':
    import numpy as np
    import spotipy
    from spotipy import SpotifyOAuth

    t = np.array([3.98524329e-02, 3.16137858e-02, 3.23992074e-02, -2.83146277e-04,
                  2.96338857e-03, 1.88571271e-02, -5.14779352e-02, -1.14576317e-01,
                  -3.29316184e-02, -2.55983900e-02, -2.78050732e-02, 9.52437744e-02,
                  -1.01240035e-02, -9.58775356e-02, -4.47720988e-03, 1.79863293e-02,
                  4.74480689e-02, 1.75522398e-02, 3.22759487e-02, 6.30711205e-03,
                  -4.78647649e-02, -1.39652670e-03, 2.31616348e-02, 5.38187437e-02,
                  -2.99762860e-02, 2.82087438e-02, -4.87486348e-02, -2.36950889e-02,
                  3.17773409e-02, -5.93009926e-02, 2.22035907e-02, 3.09813749e-02,
                  9.31304544e-02, -3.01535204e-02, -1.15478121e-01, 3.65928421e-03,
                  4.96121682e-03, 8.09563771e-02, -1.07613429e-02, -2.82535423e-02,
                  1.84638985e-02, 8.04194901e-03, 3.62371877e-02, 2.54942924e-02,
                  -1.10530946e-02, -5.36251552e-02, -7.79988170e-02, -3.06395870e-02,
                  -2.27590017e-02, 8.20589960e-02, -6.05950095e-02, -3.37023623e-02,
                  8.20485502e-02, -1.51725896e-02, -6.48993328e-02, -6.91663893e-03,
                  -1.45509548e-03, 7.68415257e-02, -2.93590818e-02, 2.60914024e-02,
                  -3.67600247e-02, -5.09372763e-02, -3.71475630e-02, -1.85097642e-02,
                  2.31558811e-02, 1.83476098e-02, 4.62815389e-02, 1.06278323e-01,
                  3.47164683e-02, 4.66973856e-02, 1.57301258e-02, 7.54098147e-02,
                  3.81235890e-02, -1.11634359e-01, 6.82143867e-02, 1.95386540e-02,
                  -8.61863419e-02, -9.33823287e-02, 5.27611561e-03, -9.82097443e-03,
                  -4.96188598e-03, -1.00322857e-01, -1.23354727e-02, -1.81518063e-01,
                  -1.41920913e-02, 7.90776219e-03, -1.63478330e-02, 1.20759793e-02,
                  1.80471335e-02, 9.53133870e-03, -6.11700211e-03, 3.22846211e-02,
                  -6.37408271e-02, -3.96243390e-03, 5.99787496e-02, 3.10406405e-02,
                  -4.78389487e-02, 3.41832899e-02, 2.93112849e-03, 9.27571673e-03,
                  1.10258691e-01, 1.19542688e-01, -2.13671159e-02, 2.12247577e-02,
                  -6.76115081e-02, -1.75676793e-02, 7.93226585e-02, 2.38139257e-02,
                  4.28158008e-02, -2.14214157e-02, 6.09125718e-02, 8.56544822e-02,
                  -4.37480733e-02, -3.67066786e-02, 6.01276569e-03, 2.74178907e-02,
                  3.72729748e-02, 5.47421128e-02, 1.92669630e-02, 4.42876630e-02,
                  3.64231914e-02, -1.12621216e-02, 2.62673032e-02, -4.33774292e-02,
                  -2.83703231e-03, -4.40227836e-02, -6.90995604e-02, 2.46139746e-02,
                  9.68449712e-02, -2.31832918e-02, -2.56131534e-02, 3.15167420e-02,
                  9.52287838e-02, -1.50992824e-02, -3.48836668e-02, -1.36324321e-03,
                  4.24030237e-02, 8.10394138e-02, 7.28629646e-04, 6.12506121e-02,
                  -3.04173436e-02, 5.38765118e-02, -3.88204530e-02, -1.01111107e-01,
                  -6.32747486e-02, 3.17408070e-02, -2.28749756e-02, 4.76634353e-02,
                  -8.64629447e-02, -5.25116287e-02, 1.17123211e-02, -1.68380104e-02,
                  2.30104402e-02, 4.89406250e-02, 6.71613142e-02, 6.26485497e-02,
                  9.21981595e-03, 2.78525315e-02, -1.06946025e-02, -1.69139337e-02,
                  -3.33644934e-02, -4.06030715e-02, -4.55843993e-02, 6.50356263e-02,
                  -1.22649856e-01, 5.29394187e-02, -1.57380924e-02, 2.06411239e-02,
                  -5.38176997e-03, -4.97518666e-02, -5.40309725e-03, -7.81031400e-02,
                  6.68094354e-03, 1.34734269e-02, -4.62908521e-02, -3.02302204e-02,
                  8.56233537e-02, -1.22912852e-02, -8.34340081e-02, -7.55414814e-02,
                  -7.48570776e-03, -7.52378702e-02, -6.98635494e-03, 4.25974503e-02,
                  -6.32664934e-03, 8.40061903e-03, -1.31088324e-04, 5.83669636e-03,
                  5.89583963e-02, 3.86011861e-02, -5.83080240e-02, -5.20250276e-02,
                  8.29671994e-02, 5.63341007e-02, -8.33141357e-02, -4.85780612e-02,
                  5.78612983e-02, -5.15465476e-02, -3.95477749e-02, 4.33920324e-02,
                  -7.10193720e-03, -2.07711793e-02, 1.99833270e-02, -1.33911869e-03,
                  -3.46825365e-03, 6.22206833e-04, 9.28873196e-02, 7.41636241e-03,
                  4.94527817e-02, -4.05937210e-02, 4.42973524e-03, -1.98590383e-02,
                  -5.87368906e-02, -1.03029460e-02, 6.45783870e-03, -4.31503877e-02,
                  -5.66938445e-02, -3.49433012e-02, -2.24196669e-02, -2.16163378e-02,
                  3.08692828e-02, -8.44462886e-02, -6.18666410e-02, 1.13810011e-32,
                  4.30340320e-02, -1.90104991e-02, -3.08186375e-02, 1.77868940e-02,
                  4.66023348e-02, 7.70269409e-02, 3.13893780e-02, 3.63538675e-02,
                  2.06103139e-02, 4.31664735e-02, 7.52491206e-02, -2.14533857e-03,
                  2.46758722e-02, 5.19259721e-02, -3.80812585e-02, -2.00807136e-02,
                  -7.59510025e-02, 1.68989059e-02, 1.31041408e-02, 1.12176333e-02,
                  -5.81053868e-02, -2.64335517e-02, 1.33622915e-01, 6.73113111e-03,
                  -3.11196391e-02, 1.31077704e-03, -3.54628600e-02, 2.74845585e-02,
                  4.68796380e-02, 4.20015082e-02, 1.25261426e-01, 4.19309922e-02,
                  -5.18146344e-02, -1.68137521e-01, -6.51168823e-02, -2.34438572e-02,
                  1.41661495e-01, 2.01895204e-03, -8.15720633e-02, 4.79200594e-02,
                  2.51318850e-02, 3.23879197e-02, 3.96737680e-02, 2.31007207e-03,
                  6.66036829e-02, 7.00233281e-02, -8.84486437e-02, 4.88169938e-02,
                  -1.43954501e-01, 3.95496897e-02, -5.55324228e-03, -2.48396583e-03,
                  -6.47971407e-02, -3.82932350e-02, -2.37228088e-02, -2.36101821e-02,
                  -9.40505508e-03, -2.77286302e-02, -7.02887475e-02, -2.54783537e-02,
                  -4.00272049e-02, 1.03159659e-02, -7.69613907e-02, -6.70081005e-02,
                  -1.62635315e-02, -2.24696752e-02, -2.99547892e-02, 6.13815188e-02,
                  -6.19134940e-02, 3.10239196e-02, -9.38739777e-02, 6.02519028e-02,
                  -6.02355460e-03, -1.35048814e-02, 2.17671040e-02, 1.36691844e-02,
                  3.87780257e-02, -9.01098922e-02, 1.76694393e-02, 1.01598473e-02,
                  3.52742560e-02, 5.87688424e-02, -1.06122628e-01, 4.67139594e-02,
                  -1.82013214e-02, 8.58179033e-02, -3.83672379e-02, 4.71821688e-02,
                  7.86624663e-03, -4.08248901e-02, 6.09863829e-03, -8.55474249e-02,
                  -3.56371365e-02, -4.55703773e-02, 7.13594928e-02, 5.92765008e-32,
                  4.40592039e-03, -6.99071065e-02, 2.77207717e-02, 7.74307698e-02,
                  -5.51363267e-02, -2.27959268e-02, -1.85396697e-03, -3.06947436e-02,
                  1.19786458e-02, 2.02769358e-02, -9.00973380e-03, -6.98127151e-02,
                  2.02835370e-02, 3.07994150e-03, 3.02471891e-02, 1.15321018e-01,
                  -1.89523995e-02, 4.63644937e-02, -1.36013879e-02, -5.88405095e-02,
                  6.98835105e-02, 3.49735245e-02, 7.48915076e-02, 1.89541914e-02,
                  2.67969090e-02, 5.14951162e-02, 6.66357204e-02, -7.87291024e-03,
                  -3.36993136e-03, -4.96900268e-02, 5.96127659e-02, 3.78771164e-02,
                  4.12005138e-05, -9.29604471e-02, 2.81421077e-02, 3.45527008e-02,
                  5.28548993e-02, -7.79282972e-02, -1.68560911e-02, 7.55933970e-02,
                  -8.58284384e-02, -8.24933872e-02, -9.39667225e-03, -2.56699733e-02,
                  -6.34571835e-02, -6.09680489e-02, -2.04626862e-02, 6.01034425e-02,
                  -5.81609868e-02, 1.62859987e-02, 2.19441131e-02, -4.52369545e-03,
                  -2.24261973e-02, 1.27842473e-02, 2.91215256e-02, 1.41524896e-03,
                  -3.88959795e-02, 1.00768305e-01, -3.57694961e-02, 3.27415653e-02,
                  5.41623980e-02, 4.64604683e-02, 2.87229419e-02, 2.40065865e-02],
                 dtype=np.float32)
    
    x = generate_params(t)
    sp = spotipy.Spotify(auth_manager=SpotifyOAuth(scope="user-top-read playlist-modify-public"))
    all_genres = sp.recommendation_genre_seeds()["genres"]
    sp.recommendations(seed_genres=['pop', 'edm'], **x)
